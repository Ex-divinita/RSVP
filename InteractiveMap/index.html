<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Floor Plan - Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .active-floor {
            background-color: #1d4ed8 !important;
            color: white !important;
            border-color: #1d4ed8 !important;
        }

        /* Removed unused control/tool button styles */
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Header Section -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Palace of Congresses - Interactive Floor Plan</h1>
            <!-- Removed App Mode Subtitle -->
        </div>
        <div class="w-1/3">
            <input type="text" id="searchInput" placeholder="Search Exhibitors on this floor..."
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
    </header>

    <!-- Main Canvas Area -->
    <main class="flex-grow container mx-auto p-4 flex justify-center items-center">
        <div id="canvas-wrapper" class="relative w-full max-w-6xl bg-white shadow-lg rounded-lg border border-gray-200">
            <div class="absolute top-4 right-4 z-10 flex gap-2">
                <button data-floor="-1"
                    class="floor-switcher w-10 h-10 rounded-full bg-white border-2 border-gray-300 font-bold text-gray-700 flex items-center justify-center shadow-md hover:bg-gray-100 transition-all">-1</button>
                <button data-floor="0"
                    class="floor-switcher w-10 h-10 rounded-full bg-white border-2 border-gray-300 font-bold text-gray-700 flex items-center justify-center shadow-md hover:bg-gray-100 transition-all">0</button>
                <button data-floor="1"
                    class="floor-switcher w-10 h-10 rounded-full bg-white border-2 border-gray-300 font-bold text-gray-700 flex items-center justify-center shadow-md hover:bg-gray-100 transition-all">1</button>
                <button data-floor="2"
                    class="floor-switcher w-10 h-10 rounded-full bg-white border-2 border-gray-300 font-bold text-gray-700 flex items-center justify-center shadow-md hover:bg-gray-100 transition-all">2</button>
            </div>
            <canvas id="floorPlanCanvas"></canvas>
        </div>
    </main>

    <!-- Control Panel Removed -->

    <!-- Exhibitor Info Modal -->
    <div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Exhibitor Details</h3>
            <div class="space-y-4">
                <div><label for="exhibitorName" class="block text-sm font-medium text-gray-700">Exhibitor
                        Name</label><input type="text" id="exhibitorName"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        disabled>
                </div>
                <div><label for="logoUrl" class="block text-sm font-medium text-gray-700">Logo URL</label><input
                        type="text" id="logoUrl"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        disabled>
                </div>
                <div><label for="sector" class="block text-sm font-medium text-gray-700">Sector</label><select
                        id="sector"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        disabled></select>
                </div>
            </div>
            <!-- Editor Footer Removed -->
            <div id="modal-footer-viewer" class="mt-6 flex justify-end">
                <button id="closeModalBtn"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Close</button>
            </div>
        </div>
    </div>

    <!-- Tooltip for Viewer Mode -->
    <div id="tooltip"
        class="hidden absolute z-50 bg-white border border-gray-300 rounded-md shadow-lg p-2 max-w-xs pointer-events-none">
        <div class="flex items-center gap-3">
            <img id="tooltip-logo" src="" alt="logo" class="w-10 h-10 object-contain rounded flex-shrink-0">
            <div>
                <span id="tooltip-name" class="font-bold text-gray-800 block"></span>
                <span id="tooltip-sector" class="text-sm text-gray-600 block"></span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global Configuration ---
            const sectorColors = {
                'Unassigned': { color: 'rgba(156, 163, 175, 0.5)', stroke: '#6b7280' }, 'Energy': { color: 'rgba(250, 204, 21, 0.5)', stroke: '#d97706' },
                'Manufacturing': { color: 'rgba(59, 130, 246, 0.5)', stroke: '#1d4ed8' }, 'Construction': { color: 'rgba(249, 115, 22, 0.5)', stroke: '#c2410c' },
                'Technology': { color: 'rgba(16, 185, 129, 0.5)', stroke: '#047857' }, 'Automotive': { color: 'rgba(239, 68, 68, 0.5)', stroke: '#b91c1c' },
                'Finance': { color: 'rgba(139, 92, 246, 0.5)', stroke: '#6d28d9' },
            };

            // --- DOM Element References ---
            const canvasWrapper = document.getElementById('canvas-wrapper'); const canvasEl = document.getElementById('floorPlanCanvas');
            const floorSwitchers = document.querySelectorAll('.floor-switcher'); const searchInput = document.getElementById('searchInput');
            // Removed Editor/Mode DOM elements
            const detailsModal = document.getElementById('detailsModal'); const exhibitorNameInput = document.getElementById('exhibitorName');
            const logoUrlInput = document.getElementById('logoUrl'); const sectorInput = document.getElementById('sector');
            const modalFooterViewer = document.getElementById('modal-footer-viewer');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const tooltip = document.getElementById('tooltip'); const tooltipLogo = document.getElementById('tooltip-logo');
            const tooltipName = document.getElementById('tooltip-name'); const tooltipSector = document.getElementById('tooltip-sector');

            // --- Application State ---
            let appState = {
                activeFloor: 0,
                floors: { '-1': { backgroundURL: 'floor-1.jpg', objects: [] }, '0': { backgroundURL: 'floor0.jpg', objects: [] }, '1': { backgroundURL: 'floor1.jpg', objects: [] }, '2': { backgroundURL: 'floor2.jpg', objects: [] } }
            };
            const currentMode = 'viewer'; // Hard-coded to viewer mode
            let activeModalObject = null;
            const customProperties = ['exhibitorName', 'logoUrl', 'sector', 'id'];

            // --- Canvas Initialization ---
            const canvas = new fabric.Canvas(canvasEl, { width: canvasWrapper.clientWidth, height: (canvasWrapper.clientWidth * 2) / 3, backgroundColor: '#f9f9f9' });
            window.addEventListener('resize', () => { canvas.setWidth(canvasWrapper.clientWidth); canvas.setHeight((canvasWrapper.clientWidth * 2) / 3); canvas.renderAll(); });

            // --- Core Functions ---
            const switchFloor = (floorNumber, isLoading = false) => {
                // Removed editor-specific canvas saving
                appState.activeFloor = floorNumber; canvas.clear();
                const newFloorData = appState.floors[floorNumber];
                if (!newFloorData) {
                    console.error(`Floor data for floor ${floorNumber} not found.`);
                    return;
                }
                fabric.Image.fromURL(newFloorData.backgroundURL, (img) => {
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), { scaleX: canvas.width / img.width, scaleY: canvas.height / img.height });
                }, { crossOrigin: 'anonymous' });
                canvas.loadFromJSON({ objects: newFloorData.objects }, () => {
                    canvas.renderAll();
                    updateCanvasInteractivity();
                    // --- FIX: Apply search to newly loaded floor ---
                    handleSearch(searchInput.value);
                });
                floorSwitchers.forEach(btn => btn.classList.toggle('active-floor', parseInt(btn.dataset.floor, 10) === floorNumber));
            };

            const updateCanvasInteractivity = () => {
                canvas.discardActiveObject();
                canvas.selection = false; // Always false in viewer mode
                canvas.defaultCursor = 'default'; // Always default in viewer mode

                canvas.forEachObject(obj => {
                    const sector = obj.get('sector') || 'Unassigned';
                    const originalStroke = (sectorColors[sector] || sectorColors['Unassigned']).stroke;
                    // Always set viewer properties
                    obj.set({ selectable: false, evented: true, stroke: originalStroke, strokeWidth: 2, opacity: 1 });
                });
                canvas.renderAll();
            };

            // Removed setAppMode, enterDrawingMode, exitDrawingMode, finalizeShape

            const showModal = (targetObject) => {
                if (!targetObject) return;
                activeModalObject = targetObject;
                modalFooterViewer.style.display = 'flex'; // Always show viewer footer
                // Always disable inputs
                exhibitorNameInput.disabled = true; logoUrlInput.disabled = true; sectorInput.disabled = true;
                exhibitorNameInput.value = targetObject.get('exhibitorName') || '';
                logoUrlInput.value = targetObject.get('logoUrl') || '';
                sectorInput.innerHTML = '';
                Object.keys(sectorColors).forEach(sectorName => {
                    const option = document.createElement('option');
                    option.value = sectorName; option.textContent = sectorName;
                    sectorInput.appendChild(option);
                });
                sectorInput.value = targetObject.get('sector') || 'Unassigned';
                detailsModal.classList.remove('hidden');
            };

            const hideModal = () => { activeModalObject = null; detailsModal.classList.add('hidden'); };

            const showTooltip = (targetObject) => {
                if (!targetObject || !targetObject.exhibitorName || targetObject.exhibitorName === 'Unnamed Booth') { hideTooltip(); return; }
                const exhibitorSector = targetObject.get('sector');
                const bounds = targetObject.getBoundingRect();
                const canvasRect = canvas.getElement().getBoundingClientRect();
                tooltipName.textContent = targetObject.exhibitorName;
                tooltipLogo.src = targetObject.logoUrl || 'https://placehold.co/40x40/cccccc/969696?text=Logo';
                tooltipSector.textContent = exhibitorSector || '';
                tooltipSector.classList.toggle('hidden', !exhibitorSector);
                tooltip.style.left = `${canvasRect.left + bounds.left}px`;
                tooltip.style.top = `${canvasRect.top + bounds.top - tooltip.offsetHeight - 5}px`;
                tooltip.classList.remove('hidden');
            };

            const hideTooltip = () => { tooltip.classList.add('hidden'); };

            // --- START: ADDED SEARCH FUNCTION ---
            /**
             * Handles highlighting objects on the canvas based on the search term.
             * @param {string} searchTerm - The text from the search input.
             */
            const handleSearch = (searchTerm) => {
                const term = searchTerm.toLowerCase().trim();

                canvas.getObjects().forEach(obj => {
                    // Get original stroke color to reset non-matches
                    const sector = obj.get('sector') || 'Unassigned';
                    const originalStroke = (sectorColors[sector] || sectorColors['Unassigned']).stroke;
                    
                    const name = obj.get('exhibitorName') || '';

                    // Check if the exhibitor name includes the search term
                    if (term.length > 0 && name.toLowerCase().includes(term)) {
                        // Highlight match with a bright green
                        obj.set({
                            stroke: '#10B981', // Tailwind green-500
                            strokeWidth: 5
                        });
                    } else {
                        // Reset to original stroke
                        obj.set({
                            stroke: originalStroke,
                            strokeWidth: 2
                        });
                    }
                });
                canvas.renderAll(); // Re-render the canvas to show changes
            };
            // --- END: ADDED SEARCH FUNCTION ---


            // --- Event Listeners ---
            floorSwitchers.forEach(btn => btn.addEventListener('click', () => switchFloor(parseInt(btn.dataset.floor, 10))));

            // --- START: ADDED SEARCH EVENT LISTENER ---
            searchInput.addEventListener('input', (e) => handleSearch(e.target.value));
            // --- END: ADDED SEARCH EVENT LISTENER ---

            // Removed all editor/drawing event listeners

            canvas.on('mouse:dblclick', (options) => {
                if (options.target) {
                    showModal(options.target);
                }
                // Removed drawing-related dblclick logic
            });

            // Removed keydown listener

            canvas.on('mouse:over', (e) => {
                if (e.target) { // currentMode check removed (always viewer)
                    showTooltip(e.target);
                    // --- FIX: Only highlight if not currently search-highlighted ---
                    const currentStroke = e.target.get('stroke');
                    if (currentStroke !== '#10B981') { // Don't override search highlight
                        e.target.set({ stroke: '#0ea5e9', strokeWidth: 4 }); // Bright blue hover
                        canvas.renderAll();
                    }
                }
            });
            canvas.on('mouse:out', (e) => {
                if (e.target) { // currentMode check removed (always viewer)
                    hideTooltip();
                    // --- FIX: Only reset if not search-highlighted ---
                    const currentStroke = e.target.get('stroke');
                    if (currentStroke !== '#10B981') {
                        const sector = e.target.get('sector') || 'Unassigned';
                        const originalStroke = (sectorColors[sector] || sectorColors['Unassigned']).stroke;
                        e.target.set({ stroke: originalStroke, strokeWidth: 2 });
                        canvas.renderAll();
                    }
                }
            });

            // Modal button listeners
            closeModalBtn.addEventListener('click', hideModal);
            // Removed editor-specific modal button listeners

            // Removed Helper Functions for loading/saving

            // Auto-load function for GitHub Pages (Viewer Mode)
            const autoLoadData = async () => {
                try {
                    // --- FIX: Use the correct file name ---
                    const response = await fetch('./floor-plan-data.json');
                    if (!response.ok) {
                        throw new Error('floor-plan-data-3.json not found or failed to load.');
                    }
                    const loadedData = await response.json();
                    if (loadedData.activeFloor !== undefined && loadedData.floors) {
                        appState = loadedData;
                        switchFloor(appState.activeFloor, true);
                        // setAppMode('viewer') removed - it's the default
                    } else {
                        throw new Error('Invalid JSON structure.');
                    }
                } catch (error) {
                    console.warn(error.message);
                    // Fallback to default empty floor
                    switchFloor(0);
                    // setAppMode('viewer') removed - it's the default
                }
            };

            // --- Initial Application Load ---
            autoLoadData();
        });
    </script>
</body>
</html>
